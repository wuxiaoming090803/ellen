initFontRem();function initFontRem(){var a=document.documentElement.clientWidth;if(a>750){a=750;}document.documentElement.style.fontSize=a/7.5+"px";}$(window).resize(function(){initFontRem();
});$mapWrap=$("#mapWrap");$searchSort=$("#searchSort");var initCenter=new BMap.Point(108.30658044894886,22.873883384337855);bmapInit();$("body").off("touchend",".iconBack").on("touchend",".iconBack",function(a){a.stopPropagation();
var b=$(this).parents(".secondWrap,.resultWrap");b.animate({transform:"translateX(0)"});});var flag=false;$("body").off("touchend","#chooseKmButton").on("touchend","#chooseKmButton",function(a){a.preventDefault();
if(!flag){$(this).parents(".chooseDistance").children(".chooseKm").show();flag=true;}else{$(this).parents(".chooseDistance").children(".chooseKm").hide();
flag=false;}});$("body").off("touchend","#chooseKm span").on("touchend","#chooseKm span",function(c){c.preventDefault();var b=$(this).text();var a=$(this).attr("data");
$("#kmsum").text(b).attr("data",a);$(this).parent("#chooseKm").hide();getMarketData("http://bd.zhuisuyun.net/shianyun-web/proxy/perception/CompInfo",{lng:initCenter.lng,lat:initCenter.lat},a,"all");
flag=false;});$("body").off("touchend","#searchSort > span").on("touchend","#searchSort > span",function(){$("#mapserachResultSum").html("");$(this).addClass("current").siblings().removeClass("current");
var a=$(this).data("num");var b=$(this).children(".stext").data("type");$("#mapserachResultSum").html('<span>已选</span><span class="mapSearchSum">'+a+'</span><span>个节点</span> <span class="iconfont icon-liebiao" id="showDetailList" data-type="'+b+'"></span>');
});var _dataArray=[];$("body").off("touchend","#showDetailList").on("touchend","#showDetailList",function(){$("#r-result").html("");var a='<ul class="listUl">';
var c=$(this).data("type")=="all"?searchClass.data:$(this).data("type")=="cs"?searchClass.currentMarket:searchClass.currentJM;var d;for(var b=0;b<c.length;
b++){d=(getDistance(new BMap.Point(108.2758138185506,22.848675894991487),new BMap.Point(c[b].point.lng,c[b].point.lat))/1000).toFixed(1);a+='<li><span class="iconfont icon-yuandian"></span><p class="storeName">'+c[b].compName+'</p><p class="address">'+c[b].address+'</p><span class="distance">'+d+'km</span><span class="iconfont icon-liebiao"></span></li>';
_dataArray.push({storeName:c[b].compName,address:c[b].address,distance:d});}a+="</ul>";$("#r-result").parents(".resultWrap").animate({transform:"translateX(-100%)"});
$("#r-result").html(a);});$("body").off("tap","#r-result li").on("tap","#r-result li",function(){var b=$(this).children(".storeName").text();var a=$(this).children(".address").text();
var c=$(this).children(".distance").text();showFoodsList(b,a,c);});$("body").off("tap","#searchThumblist a").on("tap","#searchThumblist a",function(){var f=$(this).find(".thumbimg").attr("src");
var a=$(this).find(".thumbname").text();var d=$(this).find(".thumbcodename").text();var i=$(this).find(".thumbcode").text();var b=$(this).parents(".secondWrap").find(".headName").text();
var c=$(this).parents(".secondWrap").find(".headAddress").text();var e=$(this).parents(".secondWrap").find(".headDistance").text();var h="";h+='<div class="searchListHead"><span class="iconfont icon-jiantouBack iconBack"></span><div class="headlist" id="head-searchThumb"><span class="headName">'+b+'</span><br /><span class="headAddress">'+c+'</span><span class="headtance"><span class="iconfont icon-iconfontluxiandaohang"></span> <label class="headDistance">'+e+"</label></span></div></div>";
var g='<div class="searchListBody" id="searchThumblistBox"></div>';$mapWrap.append('<div class="secondWrap" id="searchThumbDetailBox"></div>');$("#searchThumbDetailBox").animate({transform:"translateX(-100%)"},function(){var j='{"serviceKey":"D1GHjOfkTKOo8bqdtwMBKbb1EDA1I9","param":{"traceCode":"'+i+'"}}';
var k="http://bd.zhuisuyun.net/shianyun-web/proxy/perception/traceCode/code";$.ajax({url:k,type:"post",dataType:"json",data:{requestParam:j},async:false,success:function(o,q){console.log(o);
var n=[];n.push('<img class="tImg" src="'+f+'"><p class="tName">'+o.GOODS_NAME+"</p>");n.push('<p class="tCodeName"><label>'+d+'：</lable><span class="tCode">'+o.TraceCode+"</span></p>");
n.push('<div class="tLine">');for(var m=0;m<o.List.length;m++){var p=o.List[m].split(";");var l=p[0].split("：");n.push('<div class="tLineTool clearfix"><span class="iconfont icon-dao"></span><div class="tooltipsbox"><h1>'+l[0]+'</h1><p class="addressInfo">'+l[1]+"</p><span>"+p[1]+"</span></div></div>");
}n.join("");$("#searchThumblistBox").html(n);},error:function(m,l){}});}).html(h+g);});$("body").off("touchend","#categoriesList > span").on("touchend","#categoriesList > span",function(){$(this).addClass("current").siblings().removeClass("current");
});function bmapInit(){var b=new BMap.Map("allmap");b.addControl(new BMap.MapTypeControl());b.enableScrollWheelZoom(true);initCenter=new BMap.Point(108.30658044894886,22.873883384337855);
b.centerAndZoom(initCenter,13);window.map=b;var a=new BMap.Geolocation();window.geolocation=a;a.getCurrentPosition(function(e){if(this.getStatus()==BMAP_STATUS_SUCCESS){var c=new BMap.Marker(initCenter);
b.addOverlay(c);b.panTo(initCenter);setPointToAddress(initCenter);var d=$("#kmsum").attr("data");getMarketData("http://bd.zhuisuyun.net/shianyun-web/proxy/perception/CompInfo",{lng:initCenter.lng,lat:initCenter.lat},d,"all");
}else{}},{enableHighAccuracy:true});}function SearchClass(b){this.data=b;this.currentMarket=[];this.currentJM=[];for(var a=0;a<this.data.length;a++){if(b[a].marketTypeName=="超市"){this.currentMarket.push(b[a]);
}else{this.currentJM.push(b[a]);}}}SearchClass.prototype.filter=function(b){if(this.data==null){alert("无结果显示!");return false;}showTotalData(this.currentMarket.length,this.currentJM.length,this.data.length);
var a=[];if(b=="all"){a=this.data;}else{if(b=="CS"){a=this.currentMarket;}else{if(b=="JM"){a=this.currentJM;}}}return a;};var _dataProductArray=[];function getMarketData(e,b,a,c){var d='{"serviceKey":"D1GHjOfkTKOo8bqdtwMBKbb1EDA1I9","param":{"lat":'+b.lat+',"lng":'+b.lng+',"raidus":'+a+"}}";
$.ajax({url:e,type:"post",dataType:"json",data:{requestParam:d},async:false,success:function(f,g){console.log(f);_dataProductArray=f;searchClass=null;searchClass=new SearchClass(f.data);
search(c,f.data);}});}function setPointToAddress(a){var b="";var c=new BMap.Geocoder();c.getLocation(a,function(d){$("#mapSearchText").prop("value",d.address);
});}function search(e,b){var g=searchClass.filter(e);addMarker(g);var j=[],d={},h=[];j.push('<div class="traceList" id="traceList"><h1>可追溯的商品</h1><span class="traceBox"><span class="tracepro">');
for(var c=0;c<b.length;c++){var a=b[c].goodsList;$.each(a,function(i,k){d[a[i]["goodsId"]]=a[i]["goodsName"];});}$.each(d,function(i,k){j.push('<a data-id="'+i+'" class="traceProduct">'+k+"</a>");
});j.push("</span></span></div>");var f=$("#traceList");if(f.length>=1){f.remove();}$mapWrap.append(j.join(""));clickHandler("traceProduct",b);}function clickHandler(e,f){if($(e).hasClass("current")){$(e).removeClass("current");
}else{$(e).addClass("current").removeClass("current");}var c=$(e).data("id");var l=[],a=[],k=true;for(var g=0;g<f.length;g++){var b=f[g].goodsList,h=[];
for(var d=0;d<b.length;d++){h.push(parseInt(b[d]["goodsId"]));}if($.inArray(c,h)<0){k=false;}else{k=true;}if(!k){a.push(f[g]);}}changeMarker(a,f);}function changeMarker(e,g){map.clearOverlays();
for(var d=0;d<g.length;d++){var c=g[d];var a=new BMap.Point(c.point.lng,c.point.lat);var f=c.marketTypeName=="超市"?myIcon1:myIcon2;var b=new BMap.Marker(a,{icon:f});
map.addOverlay(b);}for(var d=0;d<e.length;d++){var a=new BMap.Point(e[d]["point"].lng,e[d]["point"].lat);var f=e[d].marketTypeName=="超市"?myIcon1_grey:myIcon2_grey;
var b=new BMap.Marker(a,{icon:f});map.addOverlay(b);}}var opts={width:250,height:140};var myIcon1=new BMap.Icon("img/CSMarker.png",new BMap.Size(19,30));
var myIcon2=new BMap.Icon("img/JMMarker.png",new BMap.Size(27,30));var myIcon1_grey=new BMap.Icon("img/CSMarker_grey.png",new BMap.Size(27,30));var myIcon2_grey=new BMap.Icon("img/JMMarker_grey.png",new BMap.Size(27,30));
function addClickHandler(b,a){a.addEventListener("click",function(c){openInfo(b,c);document.getElementById("detail").onclick=function(){alert("asd");};
});}function openInfo(c,f){var d=f.target;var a=new BMap.Point(d.getPosition().lng,d.getPosition().lat);var b=new BMap.InfoWindow(c,opts);map.openInfoWindow(b,a);
}function addMarker(c){map.clearOverlays();for(var d=0;d<c.length;d++){var k=c[d];var h=new BMap.Point(k.point.lng,k.point.lat);var g=k.marketTypeName=="超市"?myIcon1:myIcon2;
var e=new BMap.Marker(h,{icon:g});var f="<div class='infoWindow clearfix'><div class='head'><h2 class='title'>"+k.compName+"</h2><h3 class='secondTitle'>"+k.address+"<i class='icon iconfont icon-iconfontluxiandaohang'></i></h3></div><ul class='list'>";
for(var a=0;a<k.goodsList.length;a++){var b=k.goodsList[a];f+="<li><i class='icon iconfont icon-yuandian'></i>"+b.goodsName+"</li>";if(a==2){break;}}f=f+"</ul><span class='detail' data-name='"+k.compName+"' data-address='"+k.address+"' data-distance='"+(getDistance(initCenter,new BMap.Point(k.point.lng,k.point.lat))/1000).toFixed(1)+"km' onclick='showDetail(this)'>详情</span><span class='arrow'><i class='inner'></i></span></div>";
map.addOverlay(e);addClickHandler(f,e);}}function showDetail(c){var b=$(c).data("name");var a=$(c).data("address");var d=$(c).data("distance");showFoodsList(b,a,d);
}function getDistance(b,a){return BMapLib.GeoUtils.getDistance(b,a);}function showTotalData(b,c,d){var a;a+='<div class="searchSort" id="searchSort"><span id="marketBtn" data-num="'+b+'"><span class="marketSUM">'+b+'</span><span class="stext" data-type="cs">超市</span></span><span id="foodmarketBtn" data-num="'+c+'"><span class="foodmarketSUM">'+c+'</span><span class="stext" data-type="jm">集贸</span></span></div>';
if($searchSort.length>=1){$searchSort.remove();}$mapWrap.append(a);$("#mapserachResultSum").html('<span>共有</span><span class="mapSearchSum">'+d+'</span><span>个节点</span> <span class="iconfont icon-liebiao" id="showDetailList" data-type="all"></span>');
}function showFoodsList(c,a,e){var d="";d+='<div class="searchListHead"><span class="iconfont icon-jiantouBack iconBack"></span><div class="headlist" id="head-searchThumb"><span class="headName">'+c+'</span><br /><span class="headAddress">'+a+'</span><span class="headtance"><span class="iconfont icon-iconfontluxiandaohang"></span> <label class="headDistance">'+e+"</label></span></div></div>";
var b='<div class="searchListBody" id="searchThumbBox"><ul class="searchThumblist" id="searchThumblist"></ul></div>';$mapWrap.append('<div class="secondWrap" id="searchThumbBox"></div>');
$("#searchThumbBox").animate({transform:"translateX(-100%)"},function(){var f='{"serviceKey":"D1GHjOfkTKOo8bqdtwMBKbb1EDA1I9","param":{"nodeId":"450103309"}}';
var g="http://bd.zhuisuyun.net/shianyun-web/proxy/perception/traceId";$.ajax({url:g,type:"post",dataType:"json",data:{requestParam:f},async:false,success:function(k,l){console.log(k.data);
var k=k.data;var j="";for(var h=0;h<k.length;h++){j+='<li><a><img class="thumbimg" src="img/'+k[h].goodsId+'.png"><p class="thumbname">'+k[h].goodsName+'</p><p class="thumbcodename">肉菜流通追溯码</p><p class="thumbcode">'+k[h].traceId+'</p><p class="thumbline"><span class="iconfont icon-dao"></span><span class="iconfont icon-car2"></span><span class="iconfont icon-fangziall"></span><span class="iconfont icon-gouwuche"></span></p></li></a>';
}$("#searchThumblist").html(j);}});}).html(d+b);}function getProductSort(f){var e={},b=[];$(f).addClass("current").siblings().removeClass("current");var c=$(f).children(".iconfont");
var a=$("#categoriesBox");if(c.hasClass("icon-kongdown")){c.addClass("icon-kongup").removeClass("icon-kongdown");a.show();}else{c.addClass("icon-kongdown").removeClass("icon-kongup");
a.hide();}console.log(_dataProductArray);for(var d=0;d<_dataProductArray.data.length;d++){var g=_dataProductArray.data[d].goodsList;$.each(g,function(h,i){e[g[h]["goodsId"]]=g[h]["goodsName"];
});}b.push('<div id="categoriesList" class="categoriesList">');$.each(e,function(h,i){b.push('<span data-key="'+h+'">'+i+"</span>");});b.push("</div>");
$("#categoriesBox").html(b.join(""));}function getDistanceSort(d){$(d).addClass("current").siblings().removeClass("current");$("#categoriesBox").hide();
var b=$(d).children(".iconfont");if(b.hasClass("icon-kongdown")){b.addClass("icon-kongup").removeClass("icon-kongdown");_dataArray.sort(getSortFun("asc","distance"));
}else{b.addClass("icon-kongdown").removeClass("icon-kongup");_dataArray.sort(getSortFun("desc","distance"));}var a='<ul class="listUl">';for(var c=0;c<_dataArray.length;
c++){a+='<li><span class="iconfont icon-yuandian"></span><p class="storeName">'+_dataArray[c].compName+'</p><p class="address">'+_dataArray[c].address+'</p><span class="distance">'+_dataArray[c].distance+'km</span><span class="iconfont icon-liebiao"></span></li>';
}a+="</ul>";$("#r-result").html(a);}function getSortFun(b,d){var c=(b=="asc")?">":"<";var a=new Function("a","b","return a."+d+c+"b."+d+"?1:-1");return a;
}